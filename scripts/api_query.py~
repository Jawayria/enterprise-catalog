#!/usr/bin/python
"""
Script to make manual requests against the Discovery Service (in some environment).

Easy to execute as `python -m scripts.discovery_query`
"""
import os

from enterprise_catalog.apps.api_client.discovery import *


class ScriptingDiscoveryClient(DiscoveryApiClient):
    """
    Object builds an API client to make calls to the Discovery Service.
    """
    def __init__(
        self, oauth_base_url=None, oauth_client_id=None,
        oauth_client_secret=None, discovery_service_api_url=None
    ):
        self._oauth_base_url = oauth_base_url
        self._oauth_client_id = oauth_client_id
        self._oauth_client_secret = oauth_client_secret
        self._discovery_service_api_url = discovery_service_api_url

        self.client = OAuthAPIClient(
            self.oauth_base_url,
            self.oauth_client_id,
            self.oauth_client_secret,
        )

    @property
    def oauth_base_url(self):
        # For example: https://courses.edx.org/
        from_env = os.environ.get('OAUTH_BASE_URL')
        result = self._oauth_base_url or from_env
        assert result, 'OAUTH_BASE_URL must be set in env or provided to client on init!'
        return result

    @property
    def oauth_client_id(self):
        from_env = os.environ.get('OAUTH_CLIENT_ID')
        result = self._oauth_client_id or from_env
        assert result, 'OAUTH_CLIENT_ID must be set in env or provided to client on init!'
        return result

    @property
    def oauth_client_secret(self):
        from_env = os.environ.get('OAUTH_CLIENT_SECRET')
        result = self._oauth_client_secret or from_env
        assert result, 'OAUTH_CLIENT_SECRET must be set in env or provided to client on init!'
        return result

    @property
    def SEARCH_ALL_ENDPOINT(self):
        """
        Yes, this is, indeed, unconventional.
        For example: https://discovery.edx.org/api/v1 
        """
        from_env = os.environ.get('DISCOVERY_SERVICE_API_URL')
        result = self._discovery_service_api_url or from_env
        assert result, 'DISCOVERY_SERVICE_API_URL must be set in env or provided to client on init!'
        return urljoin(result, self.SEARCH_ALL_EXTENSION)


def get_metadata_from_content_filter(**client_kwargs):
    """
    An example function to make a request against the discovery service's `search/all` endpoint.
    """
    disco_client = ScriptingDiscoveryClient(**client_kwargs)
    import pdb; pdb.set_trace()
    content_filter = {
        'availability': ['Current', 'Starting Soon', 'Upcoming'],
        'content_type': 'course',
        'partner': 'edx',
        'level_type': ['Introductory', 'Intermediate', 'Advanced']
    }
    results = disco_client.get_metadata_by_query(content_filter)
    return results


if __name__ == '__main__':
    get_metadata_from_content_filter()
